# Kubernetes 配置管理提案

## 1. 简介

### 1.1 问题陈述

当前的 Kubernetes 配置管理设计将配置分割为单个 `.kube/config` 文件中的集群、用户和上下文。这种方法带来了几个挑战：

- `.kube/config` 文件随着众多条目变得难以管理
- 维护单个组件（集群、用户、上下文）很麻烦
- 大多数 kubeconfig 文件都是作为完整的 YAML 文档分发的，使得当前的分段方法不直观
- 没有明确的方法来管理多个环境或项目

### 1.2 提议的解决方案

我们建议转向基于文件的管理方法，其中：
- 完整的 kubeconfig 文件单独存储在专用目录 (`~/.kube/configs/`) 中。
- ConfigForge 通过覆盖主 `~/.kube/config` 文件来管理这些配置之间的切换。
- 在发现过程中执行基本的文件验证。
- 简单的备份机制 (`~/.kube/config.bak`) 保存先前的配置。

这种方法旨在简化处理多个完整 kubeconfig 文件的用户的管理，减少手动编辑主 `~/.kube/config` 的需求。

## 2. 设计目标和原则

### 2.1 主要目标

- **简化配置管理**：消除手动编辑 `.kube/config` 文件的需求
- **改善组织**：提供直观的方式来分类和查找配置
- **增强用户体验**：使配置切换无缝和可视化

### 2.2 设计原则

- **基于文件的方法**：将每个配置存储为完整的文件
- **原子操作**：确保配置切换是可靠和可恢复的
- **文件系统发现**：依赖直接目录扫描进行配置发现
- **覆盖并备份**：配置切换涉及在创建备份后覆盖主配置文件

## 3. 架构概述

### 3.1 系统组件

```
┌─────────────────┐      ┌─────────────────┐
│                 │      │                 │
│  配置库         │◄────►│ 配置切换器      │
│ (`~/.kube/configs/`)│      │ (包括备份)      │
│                 │      │                 │
└────────┬────────┘      └────────┬────────┘
         │                        │
         │                        │
         ▼                        ▼
┌─────────────────┐      ┌─────────────────┐
│                 │      │                 │
│  文件系统       │      │  活动配置       │
│  服务           │      │ (`~/.kube/config`)│
│ (读/写/列表)    │      │                 │
│                 │      │                 │
└─────────────────┘      └─────────────────┘
```

### 3.2 组件描述

1.  **配置库**：代表存储单个 kubeconfig 文件的 `~/.kube/configs/` 目录。发现涉及列出此目录中的文件。
2.  **配置切换器**：处理激活所选配置的过程。这涉及：
    *   读取当前的 `~/.kube/config`。
    *   将其内容写入 `~/.kube/config.bak`。
    *   从 `~/.kube/configs/` 读取所选文件。
    *   将其内容写入 `~/.kube/config`。
3.  **文件系统服务**：处理底层文件操作：读取目录内容，读取文件内容，写入文件内容和基本验证（例如，尝试解析）。
4.  **活动配置**：`~/.kube/config` 文件，在切换过程中由 ConfigForge 主动管理（覆盖）。

## 4. 文件组织结构

```
~/.kube/
├── config                 # 活动配置文件，由 ConfigForge 管理
├── config.bak             # 先前活动配置文件的备份
└── configs/               # 包含单个 kubeconfig 文件的目录
    ├── prod-cluster-a.yaml
    ├── dev-cluster-b.yaml
    └── staging-cluster-c.yaml
```

## 7. 用户界面设计

### 7.2 配置列表

侧边栏列出发现的 Kubernetes 配置，包括活动配置和来自 `configs/` 目录的文件。

**主要功能：**
- 显示活动的 `~/.kube/config`（明确标记）。
- 列出 `~/.kube/configs/` 中的所有文件。
- 指示验证状态（例如，标记无效/无法解析的文件）。
- 提供一个"添加"按钮，在 `~/.kube/configs/` 中创建新的空配置文件。
- 包含用于文件管理和激活的上下文菜单操作。
- 如果未找到配置，则显示空状态消息。

### 7.4 配置编辑器

显示所选配置文件（活动 `config` 或 `configs/` 中的文件）的内容。默认为只读模式。

**主要功能：**
- **默认只读**：默认情况下在不可编辑的查看器中显示 YAML 内容。
- **语法高亮**：查看器和编辑器都必须支持 YAML 语法高亮。
- **显式编辑模式**："编辑"按钮切换到可编辑的文本区域。
- **保存/取消**：在编辑模式下，"保存"将更改写回文件，"取消"放弃更改。
- **处理损坏的文件**：允许查看并尝试编辑甚至标记为无效/损坏的文件。


### 7.8 命令行界面 (CLI) 设计

现有的 CLI 命令需要适应新的基于文件的管理模型。

**`configforge kube list` (或 `cf k l`)**

*   **功能：** 列出可用的 Kubernetes 配置。
*   **实现：**
    *   扫描 `~/.kube/configs/` 目录中的配置文件（例如 `.yaml`、`.kubeconfig`）。
    *   读取活动 `~/.kube/config` 文件的内容。
    *   将 `~/.kube/config` 的内容与 `~/.kube/configs/` 中的每个文件进行比较，以确定哪个当前是活动的。（注：这需要读取所有文件，对于许多大文件可能会很慢。未来的优化可能涉及在切换时将活动文件名存储在某处）。
    *   输出在 `~/.kube/configs/` 中找到的文件名列表。
    *   在列表中清楚地标记当前活动的配置（例如，`* active-config.yaml (active)`）。
    *   可选地（例如，使用 `-v` 或 `--validate` 标志），尝试解析每个列出的文件，并指示它是否有效或可能损坏。
*   **示例输出：**
    ```
    可用的 Kubernetes 配置：
      dev-cluster.yaml
    * prod-cluster.yaml (活动)
      staging-cluster.yaml [无效]
    ```

**`configforge kube set <filename>` (或 `cf k set <filename>`)**

*   **功能：** 将指定的配置文件设置为活动配置。
*   **参数：** `<filename>` - `~/.kube/configs/` 目录中的文件名（例如 `dev-cluster.yaml`）。
*   **实现：**
    *   验证指定的 `<filename>` 存在于 `~/.kube/configs/` 中。
    *   读取 `~/.kube/config` 的当前内容。
    *   将此内容写入 `~/.kube/config.bak`（覆盖先前的备份）。
    *   读取 `~/.kube/configs/<filename>` 的内容。
    *   将此内容写入 `~/.kube/config`（覆盖活动配置）。
    *   打印确认消息（例如，"已将活动 Kubernetes 配置切换为 <filename>"）。
*   **注意：** 此命令*替换*了调用 `kubectl config use-context` 的旧逻辑。

**`configforge kube current` (或 `cf k current`)**

*   **功能：** 显示有关当前活动配置的信息。
*   **实现选项：**
    *   **选项 A（首选但可能较慢）：** 读取 `~/.kube/config` 并将其内容与 `~/.kube/configs/` 中的文件进行比较，以确定并打印匹配的文件名。
    *   **选项 B（更简单的回退）：** 读取 `~/.kube/config` 并打印其内部 `current-context` 字段的值。这需要明确记录它显示的是*内部*上下文，而不是活动*文件*。
    *   **选项 C（混合）：** 尝试选项 A。如果找到匹配的文件，打印其名称。还打印 `~/.kube/config` 中的内部 `current-context`。
*   **决定：** 最初实现选项 C 以获取最多信息，清楚地标记推断出的活动文件（如果找到）和内部上下文。
*   **示例输出（选项 C）：**
    ```
    活动配置文件：prod-cluster.yaml（推断）
    内部当前上下文：admin@prod-cluster
    ```
    或者如果文件匹配失败：
    ```
    活动配置文件：未知（内容与 ~/.kube/configs/ 中的任何文件都不匹配）
    内部当前上下文：admin@prod-cluster
    ```
